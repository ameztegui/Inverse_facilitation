{
    "collab_server" : "",
    "contents" : "rm(list=ls())\n\nlibrary(likelihood)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(reshape2)\nlibrary(forcats)\n\nload(\"./data/Data.Rdata\")\nload(\"./Data/Climate_Data.Rdata\")\n\ntargets <- cbind(targets, clima)\ntargets <- targets %>%\n      mutate(DG = rowMeans(dplyr::select(.,DG_16:DG_14),na.rm=TRUE),\n             D = DB_t - (DG_16 + DG_15 + DG_14)) %>%\n      dplyr::select(ID_plot:Y_UTM,Age, DG, D,prec, temp)\n\nneighbours <- neighbours %>%\n      mutate(Species2 = fct_lump(Species, n=4))\n\n# Create the datasets for computing neighborhood indices ------------------\n\nneighbours$vecinos <- sequence(tabulate(neighbours$ID_pine+1))\n\ndbhs <- dcast(data=neighbours, ID_pine ~ vecinos, value.var= \"DB_n\")[,-1]\ndistances <- dcast(data=neighbours, ID_pine ~ vecinos, value.var= \"Dist\")[,-1]\nspecies <- dcast(data=neighbours, ID_pine ~ vecinos, value.var= \"Species2\")[,-1]\n\nusing.targets <- complete.cases(targets)\nwk.targets <- targets[using.targets,]\nwk.dbhs <- dbhs[using.targets,]\nwk.distances <- distances[using.targets,]\nwk.species <- species[using.targets,]\n\nnci_function <- function(j) {\n      \n      all.spp <- levels(neighbours$Species2)\n      neigh.lambda.indexes <- apply(wk.species, c(1,2),\n                                    function(x) {\n                                          if (is.na(x)) {\n                                                NA\n                                          } else {\n                                                which(all.spp == x) \n                                          }})\nmodel_functions= list (\n      ## Null model\n      \n      \n      Model.01 <- function (PotGrowth) {\n            PotGrowth},\n      \n      ## Size effect\n      Model.02 <- function (PotGrowth, sizeX0, sizeXb) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            PotGrowth * size.effect\n      },\n      \n      ## Size effect + competition effect\n      Model.03 <- function(PotGrowth, sizeX0, sizeXb, alpha, beta, C,D) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            nci <- rowSums((wk.dbhs^alpha)/(wk.distances^beta), na.rm=T)\n            competition.effect <- exp(-(C/100) * nci^D)\n            PotGrowth * size.effect * competition.effect \n      },\n      \n      ## Size effect + competition effect (with tree size)\n      Model.04 <- function(PotGrowth, sizeX0, sizeXb, alpha, beta,\n                           Cprim, D,gamma) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            nci <- rowSums((wk.dbhs^alpha)/(wk.distances^beta), na.rm=T)\n            C <- Cprim/100 * wk.targets$D^gamma \n            competition.effect <- exp(-(C) * (nci)^D)\n            PotGrowth * size.effect * competition.effect \n      },\n\n        ## Size effect + competition effect (with lambda)\n      Model.05 <- function(PotGrowth, sizeX0, sizeXb, lambdaVec, \n                           alpha, beta, Cprim, D, gamma) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            lambda.vals <- lambdaVec[neigh.lambda.indexes]\n            dim(lambda.vals) <- dim(neigh.lambda.indexes)\n            nci <- rowSums(lambda.vals *(wk.dbhs ^ alpha)/(wk.distances ^ beta), na.rm=T)\n            C <- Cprim/100 * wk.targets$D^gamma\n            competition.effect <- exp(-(C) * (nci)^D)\n            PotGrowth * size.effect * competition.effect\n      },\n      \n      ## Size effect + competition effect (with lambda) + climate effect\n      Model.06 <- function(PotGrowth, sizeX0, sizeXb, lambdaVec, \n                           alpha, beta, Cprim, D, gamma, \n                           tempX0, tempXb, precX0, precXb) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            lambda.vals <- lambdaVec[neigh.lambda.indexes]\n            dim(lambda.vals) <- dim(neigh.lambda.indexes)\n            nci <- rowSums(lambda.vals *(wk.dbhs ^ alpha)/(wk.distances ^ beta), na.rm=T)\n            C <- Cprim/100 * wk.targets$D^gamma\n            competition.effect <- exp(-(C) * (nci)^D)\n            temp.effect <- exp(-0.5*((wk.targets$temp-tempX0)/tempXb)^2)\n            prec.effect <- exp(-0.5*((wk.targets$prec-precX0)/precXb)^2)\n            \n            PotGrowth * size.effect * competition.effect * temp.effect * prec.effect\n      },\n      \n      Model.07 <- function(PotGrowth, sizeX0, sizeXb, alpha, beta, C,D,\n                              tempX0, tempXb, precX0, precXb) {\n            size.effect <- exp(-0.5*((log(wk.targets$D/sizeX0)/sizeXb)^2))\n            nci <- rowSums((wk.dbhs^alpha)/(wk.distances^beta), na.rm=T)\n            competition.effect <- exp(-(C/100) * nci^D)\n            temp.effect <- exp(-0.5*((wk.targets$temp-tempX0)/tempXb)^2)\n            prec.effect <- exp(-0.5*((wk.targets$prec-precX0)/precXb)^2)\n            PotGrowth * size.effect * competition.effect * temp.effect * prec.effect\n      }\n      )\n\n\n      # Get parameters ---------------------------------------------------------\n            # Initial parameters ------------------------------------------------------\n            par_model <- list(par_Model.01 = list(PotGrowth = 0.5,\n                                      sd = 2),\n                  \n                              par_Model.02 = list(PotGrowth = 0.5, \n                                      sizeX0= 5, \n                                      sizeXb= 1,\n                                      sd = 2),\n                  \n                              par_Model.03 = list(PotGrowth = 0.5, \n                                      sizeX0= 5, \n                                      sizeXb= 1,\n                                      alpha = 2,\n                                      beta = 1,\n                                      C = 0.0001,\n                                      D =1,\n                                      sd = 2),\n                  \n                              par_Model.04 = list(PotGrowth = 0.5, \n                                      sizeX0= 5, \n                                      sizeXb= 1,\n                                      alpha = 2,\n                                      beta = 1,\n                                      Cprim = 0.001,\n                                      D =1,\n                                      gamma = 0.5,\n                                      sd = 2),\n                              \n                              par_Model.05 = list(PotGrowth = 0.5, \n                                                  sizeX0= 5, \n                                                  sizeXb= 1,\n                                                  alpha = 2,\n                                                  beta = 1,\n                                                  lambdaVec=rep(0.5,5),\n                                                  Cprim = 0.001,\n                                                  D =1,\n                                                  gamma = 0.5,\n                                                  sd = 2),\n                              par_Model.06 = list(PotGrowth = 0.5, \n                                                  sizeX0= 5, \n                                                  sizeXb= 1,\n                                                  alpha = 2,\n                                                  beta = 1,\n                                                  lambdaVec=rep(0.5,5),\n                                                  Cprim = 0.001,\n                                                  D =1,\n                                                  gamma = 0.5,\n                                                  tempX0 = 12,\n                                                  tempXb = 5,\n                                                  precX0 = 600,\n                                                  precXb = 100,\n                                                  sd = 2),\n                              par_Model.07 = list(PotGrowth = 0.5, \n                                                  sizeX0= 5, \n                                                  sizeXb= 1,\n                                                  alpha = 2,\n                                                  beta = 1,\n                                                  C = 0.0001,\n                                                  D =1,\n                                                  tempX0 = 12,\n                                                  tempXb = 5,\n                                                  precX0 = 600,\n                                                  precXb = 100,\n                                                  sd = 2)\n                              )\n\n            # Low parameters ------------------------------------------------------\n                  par_low <- list(par_lo_Model.01 = list(PotGrowth = 0.1,\n                                       sd = 0.0001),\n                \n                              par_lo_Model.02 = list(PotGrowth = 0.1,\n                                       sizeX0= 1,\n                                       sizeXb= 0.5,\n                                       sd = 0.0001),\n                \n                              par_lo_Model.03 = list(PotGrowth = 0.1,\n                                       sizeX0= 1,\n                                       sizeXb= 0.5,\n                                       alpha = 0.5,\n                                       beta = 0.5,\n                                       C = 1e-10,\n                                       D =0.05,\n                                       sd = 0.0001),\n                \n                              par_lo_Model.04 = list(PotGrowth = 0.1,\n                                       sizeX0= 1,\n                                       sizeXb= 0.5,\n                                       alpha = 0.5,\n                                       beta = 0.5,\n                                       Cprim =1e-10,\n                                       D =0.05,\n                                       gamma = -2,\n                                       sd = 0.0001),\n                              \n                              par_lo_Model.05 = list(PotGrowth = 0.1, \n                                                  sizeX0= 1, \n                                                  sizeXb= 0.5,\n                                                  alpha = 0.5,\n                                                  beta = 0.5,\n                                                  lambdaVec=rep(0,5),\n                                                  Cprim = 1e-10,\n                                                  D =0.05,\n                                                  gamma = -2,\n                                                  sd = 2),\n                              \n                              par_lo_Model.06 = list(PotGrowth = 0.1, \n                                                     sizeX0= 1, \n                                                     sizeXb= 0.5,\n                                                     alpha = 0.5,\n                                                     beta = 0.5,\n                                                     lambdaVec=rep(0,5),\n                                                     Cprim = 1e-10,\n                                                     D =0.05,\n                                                     gamma = -2,\n                                                     tempX0 = 1,\n                                                     tempXb = 0.01,\n                                                     precX0 = 1,\n                                                     precXb = 0.01,\n                                                     sd = 2),\n                              par_lo_Model.07 = list(PotGrowth = 0.1,\n                                                     sizeX0= 1,\n                                                     sizeXb= 0.5,\n                                                     alpha = 0.5,\n                                                     beta = 0.5,\n                                                     C = 1e-10,\n                                                     D =0.05,\n                                                     tempX0 = 1,\n                                                     tempXb = 0.01,\n                                                     precX0 = 1,\n                                                     precXb = 0.01,\n                                                     sd = 0.0001)\n                              )\n\n\n\n\n            # High parameters ------------------------------------------------------\n                  par_high <- list(par_hi_Model.01 = list(PotGrowth = 1,\n                                        sd = 10),\n                 \n                                    par_hi_Model.02 = list(PotGrowth = 1, \n                                        sizeX0= 10, \n                                        sizeXb= 2,\n                                        sd = 10),\n                 \n                                    par_hi_Model.03 = list(PotGrowth = 1, \n                                        sizeX0= 10, \n                                        sizeXb= 2,\n                                        alpha = 2.5,\n                                        beta = 2.5,\n                                        C = 1000,\n                                        D = 3,\n                                        sd = 10),\n                 \n                                    par_hi_Model.04 = list(PotGrowth = 1, \n                                        sizeX0= 10, \n                                        sizeXb= 2,\n                                        alpha = 3,\n                                        beta = 3,\n                                        Cprim = 1000,\n                                        D = 3,\n                                        gamma = 4,\n                                        sd = 10),\n                                   \n                                   par_hi_Model.05 = list(PotGrowth = 1, \n                                                       sizeX0= 10, \n                                                       sizeXb= 2,\n                                                       alpha = 3,\n                                                       beta = 3,\n                                                       lambdaVec=rep(1,5),\n                                                       Cprim = 1000,\n                                                       D =3,\n                                                       gamma = 4,\n                                                       sd = 2),\n                                   \n                                   par_hi_Model.06 = list(PotGrowth = 1, \n                                                          sizeX0= 10, \n                                                          sizeXb= 2,\n                                                          alpha = 3,\n                                                          beta = 3,\n                                                          lambdaVec=rep(1,5),\n                                                          Cprim = 1000,\n                                                          D =3,\n                                                          gamma = 4,\n                                                          tempX0 = 20,\n                                                          tempXb = 100,\n                                                          precX0 = 10,\n                                                          precXb = 1000,\n                                                          sd = 2),\n                                   par_hi_Model.07 = list(PotGrowth = 1, \n                                                          sizeX0= 10, \n                                                          sizeXb= 2,\n                                                          alpha = 2.5,\n                                                          beta = 2.5,\n                                                          C = 1000,\n                                                          D = 3,\n                                                          tempX0 = 20,\n                                                          tempXb = 100,\n                                                          precX0 = 400,\n                                                          precXb = 1000,\n                                                          sd = 10)\n                                   )\n\n\n# Annealing algorithm -----------------------------------------------------\n# Define the model to use\nmodelname<- c('Model.01','Model.02','Model.03','Model.04', \n              'Model.05','Model.06', 'Model.07')\n\nmodel.flo = model_functions[[j]]\n\n# Parameter list (for effect of stage)\npar.flo = par_model[[j]]\npar_hi.flo = par_high[[j]]\npar_lo.flo  = par_low[[j]]\n\n#  set up the list of variables to use in annealing\npdf.flo = dnorm\ndep.var = \"DG\"\nvar.flo<- list(mean = \"predicted\", x = \"DG\", log=T)\n\n#  Call the annealing algorithm, specifying the proper model\nresults=anneal(model = model.flo, var = var.flo,\n               source_data =wk.targets,dep_var=\"DG\",\n               par = par.flo, par_lo=par_lo.flo, par_hi=par_hi.flo,\n               pdf=pdf.flo, hessian = FALSE, max_iter=35000)\n\nreturn(results)\n# write_results(results,paste(\"./Results/NCI_\",modelname[j],\".txt\", sep=\"\"))\n\n}\n\nresults_NCImodels <- map(1:7, nci_function)\nmodelname<- c('Model.01','Model.02','Model.03','Model.04', \n              'Model.05','Model.06', 'Model.07')\nnames(results_NCImodels) <- modelname [1:7]\n\nmodelsAIC <- map(results_NCImodels, \"aic_corr\")\nbest_pars <- map_df(results_NCImodels[7], \"best_pars\")\nbest_pars2 <- map_df(results_NCImodels[3], \"best_pars\")\n\nsave(best_pars, file= \"./data/best_pars.Rdata\")\n\n\n\n# Check results of NCI models ---------------------------------------------\n\nload(\"./data/best_pars.Rdata\")\n\nseqTemp = seq(6,15,by=0.2)\nseqPrec = seq(0,3000,by=1)\nseqDiam <- seq (0.1, 50,0.01)\nseqDist <- seq(0.01, 25, 0.1)\nseqNCI <- seq (0, 2000, 1)\n\n## For adults...\n\npini_temp.effect <- exp(-0.5*((seqTemp-0.47)/11.59)^2)\npini_prec.effect <- exp(-0.5*((seqPrec-2569.78)/2131.21)^2)\npini_size.effect <- exp(-0.5*((log(seqDiam/18.68)/1.05)^2))\npini_competition.effect <- exp(-(0.01609) * 20^(-1.23) * seqNCI)\npini_efecto_diam <- seqDiam^1.96\npini_efecto_dist <- 1/seqDist^1.11\n\npisy_temp.effect <- exp(-0.5*((seqTemp-1.09)/11.75)^2)\npisy_prec.effect <- exp(-0.5*((seqPrec-2386.2)/2660.83)^2)\npisy_size.effect <- exp(-0.5*((log(seqDiam/19.92)/1.11)^2))\npisy_competition.effect <- exp(-(0.03506) * 20^(-1.11) * seqNCI)\npisy_efecto_diam <- seqDiam^1.82\npisy_efecto_dist <- 1/seqDist^1.45\n\nplot(seqTemp, pisy_temp.effect, type =\"l\", col = \"dark orange\", ylim=c(0,1))\nlines(seqTemp, pini_temp.effect, type =\"l\", col= \"dark red\")\n\nplot(seqPrec, pisy_prec.effect, type =\"l\", col = \"dark orange\",  ylim=c(0,1))\nlines(seqPrec, pini_prec.effect, type =\"l\", col= \"dark red\")\n\nplot(seqDiam, pisy_size.effect, type =\"l\", col = \"dark orange\")\nlines(seqDiam, pini_size.effect, type =\"l\", col= \"dark red\")\n\nplot(seqDiam, pisy_efecto_diam, type =\"l\", col = \"dark orange\")\nlines(seqDiam, pini_efecto_diam, type =\"l\", col= \"dark red\")\n\nplot(seqDist, pisy_efecto_dist, type =\"l\", col = \"dark orange\")\nlines(seqDist, pini_efecto_dist, type =\"l\", col= \"dark red\")\n\nplot(seqNCI, pisy_competition.effect, type =\"l\", col = \"dark orange\")\nlines(seqNCI, pini_competition.effect, type =\"l\", col= \"dark red\")\n\n\n\n# Michaelis-Menten --------------------------------------------------------\n\nDBH <- 6\nGLI <- seq(0.01,100,0.02)\nMM <- function(GLI,DBH,A,S, D){\n      DBH^D * (A*GLI)/((A/S)+GLI)\n}\n\npisy <- MM(GLI,DBH,0.804,0.008,1)\npini <- MM(GLI,DBH, 0.30,0.029,1)\nabal <- MM(GLI,DBH,0.39,0.044,0.447)\npiun <- MM(GLI,DBH,1.304,0.0074,1.041)\n\nplot(GLI, pisy, type=\"l\", col = \"dark orange\", lwd=2)\nlines(GLI, piun, type=\"l\", col = \"black\", lwd=2)\nlines(GLI, abal, type=\"l\", col = \"dark green\", lwd=2)\nlines(GLI, pini, type=\"l\", col = \"dark red\", lwd=2)\n\n",
    "created" : 1504735905052.000,
    "dirty" : false,
    "encoding" : "ISO8859-1",
    "folds" : "",
    "hash" : "795203165",
    "id" : "489BD43D",
    "lastKnownWriteTime" : 1510216777,
    "last_content_update" : 1510216777089,
    "path" : "D:/Activity/PostFire Regeneration/Inverse_Facilitation/code/01_NCI.R",
    "project_path" : "code/01_NCI.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}